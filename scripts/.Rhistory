axis.title = element_text(size = 12)
)
}
# ---------------------------------------------------------
# figure 1: negative affect (na) comparison
# ---------------------------------------------------------
p1_na_full <- make_reactivity_plot(df_reactivity, "na", na_color, "Full Behavioral Sample", 124)
p1_na_mri  <- make_reactivity_plot(df_reactivity_mri, "na", na_color, "MRI Analytic Subset", 80)
fig_na <- p1_na_full + p1_na_mri +
plot_annotation(
title = "Negative Affect Reactivity to Momentary Stress",
theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5))
)
# ---------------------------------------------------------
# figure 2: positive affect (pa) comparison
# ---------------------------------------------------------
p2_pa_full <- make_reactivity_plot(df_reactivity, "pa", pa_color, "Full Behavioral Sample", 124)
p2_pa_mri  <- make_reactivity_plot(df_reactivity_mri, "pa", pa_color, "MRI Analytic Subset", 80)
fig_pa <- p2_pa_full + p2_pa_mri +
plot_annotation(
title = "Positive Affect Reactivity to Momentary Stress",
theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5))
)
# display plots
print(fig_na)
print(fig_pa)
# export code (optional)
# ggsave("fig1_na_reactivity.png", fig_na, width = 10, height = 5, dpi = 300)
# ggsave("fig2_pa_reactivity.png", fig_pa, width = 10, height = 5, dpi = 300)
library(ggplot2)
library(patchwork)
# colors: orange for na, blue for pa
na_color <- "#D55E00"
pa_color <- "#0072B2"
# helper function for clean publication-ready plots
make_reactivity_plot <- function(data, y_var, color, title, n_val) {
ggplot(data, aes(x = stress01, y = .data[[y_var]])) +
# 1. replace 'stat_smooth' with simple geom_line grouped by id
# this prevents the "floating" line segments and looks cleaner
geom_line(aes(group = els_id),
stat = "smooth", method = "lm",
se = FALSE, size = 0.3, alpha = 0.08, color = "grey20") +
# 2. thick population-level trend line
geom_smooth(method = "lm", size = 1.8, se = TRUE,
color = color, fill = color, alpha = 0.15) +
# 3. clean up scales
scale_x_continuous(labels = scales::percent, breaks = seq(0, 1, 0.25)) +
scale_y_continuous(breaks = seq(1, 4, 1)) +
coord_cartesian(ylim = c(1, 4), xlim = c(0, 1)) +
labs(
title = title,
subtitle = paste0("n = ", n_val),
x = "Momentary Stress Severity",
y = ifelse(y_var == "na", "Negative Affect", "Positive Affect")
) +
# 4. professional theme adjustments
theme_classic(base_size = 14) + # classic removes the grid for a cleaner look
theme(
plot.title = element_text(face = "bold", size = 14, hjust = 0),
plot.subtitle = element_text(size = 12, color = "grey30"),
axis.line = element_line(color = "black"),
panel.grid = element_blank()
)
}
# -----------------------------
# generate figures
# -----------------------------
# fig 1: negative affect (na)
p1_na_full <- make_reactivity_plot(df_reactivity, "na", na_color, "Full Behavioral Sample", 124)
p1_na_mri  <- make_reactivity_plot(df_reactivity_mri, "na", na_color, "MRI Analytic Subset", 80)
fig_na <- p1_na_full + p1_na_mri +
plot_annotation(title = "Negative Affect Reactivity to Stress",
theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))
# fig 2: positive affect (pa)
p2_pa_full <- make_reactivity_plot(df_reactivity, "pa", pa_color, "Full Behavioral Sample", 124)
p2_pa_mri  <- make_reactivity_plot(df_reactivity_mri, "pa", pa_color, "MRI Analytic Subset", 80)
fig_pa <- p2_pa_full + p2_pa_mri +
plot_annotation(title = "Positive Affect Reactivity to Stress",
theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))
print(fig_na)
print(fig_pa)
library(ggplot2)
library(patchwork)
# helper to force rendering
make_clean_plot <- function(df, y_col, line_color, title_text, n_text) {
# 1. ensure numeric to prevent blank panels
df[[y_col]] <- as.numeric(df[[y_col]])
df$stress01 <- as.numeric(df$stress01)
ggplot(df, aes(x = stress01, y = .data[[y_col]])) +
# 2. draw individual lines using geom_line instead of stat_smooth
# (this is more robust for small clusters)
geom_line(aes(group = els_id), alpha = 0.1, color = "grey50", size = 0.3) +
# 3. simple linear trend for the whole sample
geom_smooth(method = "lm", formula = y ~ x, color = line_color,
fill = line_color, alpha = 0.2, size = 1.5) +
scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
scale_y_continuous(limits = c(1, 4)) +
labs(title = title_text, subtitle = paste0("n = ", n_text),
x = "Stress Severity", y = "Affect Score") +
theme_classic(base_size = 14) +
theme(panel.grid = element_blank())
}
# negative affect panels
p_na_full <- make_clean_plot(df_reactivity, "na", "#D55E00", "Full Sample", 124)
p_na_mri  <- make_clean_plot(df_reactivity_mri, "na", "#D55E00", "MRI Subset", 80)
# positive affect panels
p_pa_full <- make_clean_plot(df_reactivity, "pa", "#0072B2", "Full Sample", 124)
p_pa_mri  <- make_clean_plot(df_reactivity_mri, "pa", "#0072B2", "MRI Subset", 80)
# combine and print
(p_na_full + p_na_mri) / (p_pa_full + p_pa_mri)
library(ggplot2)
library(patchwork)
library(dplyr)
# colors for the two outcomes
na_color <- "#D55E00"
pa_color <- "#0072B2"
# helper function for a clean, accurate panel
plot_affect_reactivity <- function(data, model, outcome_var, color, title, n_val) {
# 1. calculate model-predicted values for the thick trend line
# this ensures the line matches your reported Beta values
fixef_vals <- fixef(model)
intercept <- fixef_vals["(Intercept)"]
slope <- fixef_vals["stress_wp"]
# create a prediction line across the x-axis range
pred_df <- data.frame(stress01 = c(0, 1)) %>%
mutate(y_pred = intercept + (slope * stress01))
ggplot(data, aes(x = stress01, y = .data[[outcome_var]])) +
# 2. add jittered raw points (very transparent) to show data density
geom_jitter(alpha = 0.05, size = 0.8, width = 0.02, height = 0, color = "grey40") +
# 3. add individual subject lines (thin spaghetti)
geom_line(aes(group = els_id), stat = "smooth", method = "lm",
se = FALSE, size = 0.3, alpha = 0.07, color = "grey30") +
# 4. add the ACTUAL model trend line (calculated above)
geom_line(data = pred_df, aes(y = y_pred), color = color, size = 1.8) +
# 5. formatting
scale_x_continuous(labels = scales::percent, breaks = seq(0, 1, .25)) +
scale_y_continuous(limits = c(1, 4), breaks = 1:4) +
labs(title = title, subtitle = paste0("n = ", n_val),
x = "Stress Severity", y = "Affect Score") +
theme_classic(base_size = 12) +
theme(
plot.title = element_text(face = "bold"),
panel.grid = element_blank(),
axis.text = element_text(color = "black")
)
}
# --- generate the 4 panels using your fitted models ---
# negative affect
p_na_full <- plot_affect_reactivity(df_reactivity, m_na_124, "na", na_color, "Full Sample (NA)", 124)
p_na_mri  <- plot_affect_reactivity(df_reactivity_mri, m_na_80, "na", na_color, "MRI Subset (NA)", 80)
# positive affect
p_pa_full <- plot_affect_reactivity(df_reactivity, m_pa_124, "pa", pa_color, "Full Sample (PA)", 124)
p_pa_mri  <- plot_affect_reactivity(df_reactivity_mri, m_pa_80, "pa", pa_color, "MRI Subset (PA)", 80)
# --- combine into a final grid ---
final_fig <- (p_na_full | p_na_mri) / (p_pa_full | p_pa_mri) +
plot_annotation(tag_levels = 'A')
print(final_fig)
library(ggplot2)
library(patchwork)
library(dplyr)
# define colors
na_color <- "#D55E00" # vermillion
pa_color <- "#0072B2" # blue
# refined plotting function
plot_publication_reactivity <- function(data, model, outcome_var, color, title, n_val) {
# 1. generate fixed-effect prediction line
# this ensures the line strictly follows your reported beta (e.g., B = 14.98)
fixefs <- fixef(model)
pred_df <- data.frame(stress01 = c(0, 1)) %>%
mutate(y_hat = fixefs["(Intercept)"] + (fixefs["stress_wp"] * stress01))
ggplot(data, aes(x = stress01, y = .data[[outcome_var]])) +
# 2. jittered points to show density at 0% without creating "pillars"
geom_jitter(alpha = 0.08, size = 1, width = 0.02, height = 0.05, color = "grey50") +
# 3. subtle individual lines (reduced alpha so they don't overpower the trend)
geom_line(aes(group = els_id), stat = "smooth", method = "lm",
se = FALSE, size = 0.4, alpha = 0.05, color = "grey20") +
# 4. thick fixed-effect trend line
geom_line(data = pred_df, aes(y = y_hat), color = color, size = 2) +
# 5. clean formatting
scale_x_continuous(labels = scales::percent, breaks = seq(0, 1, .25)) +
scale_y_continuous(limits = c(1, 4), breaks = 1:4) +
labs(title = title, subtitle = paste0("n = ", n_val),
x = "Momentary Stress Severity", y = "Affect Score") +
theme_classic(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16),
panel.grid = element_blank(),
axis.line = element_line(size = 0.8)
)
}
# --- figure 1: negative affect (na) ---
fig1_left  <- plot_publication_reactivity(df_reactivity, m_na_124, "na", na_color, "Full Sample", 124)
fig1_right <- plot_publication_reactivity(df_reactivity_mri, m_na_80, "na", na_color, "MRI Subset", 80)
final_na_fig <- fig1_left + fig1_right + plot_annotation(title = "Negative Affect Reactivity")
# --- figure 2: positive affect (pa) ---
fig2_left  <- plot_publication_reactivity(df_reactivity, m_pa_124, "pa", pa_color, "Full Sample", 124)
fig2_right <- plot_publication_reactivity(df_reactivity_mri, m_pa_80, "pa", pa_color, "MRI Subset", 80)
final_pa_fig <- fig2_left + fig2_right + plot_annotation(title = "Positive Affect Reactivity")
# display
print(final_na_fig)
print(final_pa_fig)
# figures: stress severity -> affect (within-person + between-person), full sample + mri subset
suppressPackageStartupMessages({
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)
library(lme4)
library(lmerTest)
library(patchwork)
})
# -----------------------
# paths
# -----------------------
person_path <- "/Users/eu/Library/CloudStorage/OneDrive-Stanford/Research Projects/9 - EMA-Brain/ema_rsfmri_reactivity.csv"
prompt_path <- "/Users/eu/Documents/GitHub/els_ema_data/data/clean/ema_flags_master.csv"
# -----------------------
# helpers
# -----------------------
parse_event01 <- function(x) {
x <- str_trim(as.character(x))
dplyr::case_when(
x %in% c("1", "1.0", "true", "TRUE", "yes", "YES") ~ 1L,
x %in% c("0", "0.0", "false", "FALSE", "no", "NO") ~ 0L,
TRUE ~ NA_integer_
)
}
parse_stress_num <- function(x) {
x <- str_trim(toupper(as.character(x)))
x <- na_if(x, "CONDITION_SKIPPED")
x <- na_if(x, "")
suppressWarnings(readr::parse_number(x))
}
prep_long <- function(df_person, df_prompt) {
ids <- unique(df_person$els_id)
df_prompt %>%
filter(els_id %in% ids) %>%
group_by(els_id) %>%
mutate(
stress_mean = mean(stress, na.rm = TRUE),
stress_dev  = stress - stress_mean
) %>%
ungroup()
}
fit_main_effects <- function(dat, outcome) {
# includes both within-person (stress_dev) and between-person (stress_mean)
f <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 + stress_dev | els_id)"))
tryCatch(
lmer(f, data = dat, REML = FALSE),
error = function(e) lmer(update(f, . ~ . - (1 + stress_dev | els_id) + (1 | els_id)), data = dat, REML = FALSE)
)
}
pred_line <- function(fit, xvar = "stress_dev", xseq = seq(-50, 50, by = 1), hold_mean = 50) {
# predicted line at average stress_mean; re.form = na for population-level line
nd <- data.frame(stress_dev = xseq, stress_mean = hold_mean)
nd$yhat <- as.numeric(predict(fit, newdata = nd, re.form = NA))
nd
}
plot_within <- function(dat, fit, outcome_lab, title_lab) {
hold_mean <- mean(dat$stress_mean, na.rm = TRUE)
nd <- pred_line(fit, xseq = seq(min(dat$stress_dev, na.rm = TRUE), max(dat$stress_dev, na.rm = TRUE), length.out = 200),
hold_mean = hold_mean)
ggplot(dat, aes(x = stress_dev, y = .data[[outcome_lab]])) +
stat_summary_bin(fun = mean, bins = 25, geom = "point") +
geom_line(data = nd, aes(x = stress_dev, y = yhat), linewidth = 1) +
labs(
title = title_lab,
x = "momentary stress severity (deviation from each adolescent’s mean)",
y = ifelse(outcome_lab == "na", "negative affect", "positive affect")
) +
theme_classic(base_size = 14)
}
plot_between <- function(dat, outcome_lab, title_lab) {
df_bp <- dat %>%
group_by(els_id) %>%
summarise(
stress_mean = mean(stress, na.rm = TRUE),
affect_mean = mean(.data[[outcome_lab]], na.rm = TRUE),
.groups = "drop"
)
ggplot(df_bp, aes(x = stress_mean, y = affect_mean)) +
geom_point() +
geom_smooth(method = "lm", se = TRUE) +
labs(
title = title_lab,
x = "average stress severity across prompts",
y = ifelse(outcome_lab == "na", "average negative affect", "average positive affect")
) +
theme_classic(base_size = 14)
}
# -----------------------
# load + derive affect + stress
# -----------------------
df_person <- read_csv(person_path, show_col_types = FALSE) %>%
mutate(els_id = as.character(els_id))
# mri ids: uses rest_final_at_tp == 1 if present; otherwise falls back to scan_available_at_timepoint == true
mri_flag <- if ("rest_final_at_tp" %in% names(df_person)) {
df_person$rest_final_at_tp == 1
} else if ("scan_available_at_timepoint" %in% names(df_person)) {
df_person$scan_available_at_timepoint == TRUE
} else {
rep(FALSE, nrow(df_person))
}
df_prompt <- read_csv(prompt_path, show_col_types = FALSE) %>%
mutate(
els_id = as.character(clean_id),
na = rowMeans(across(c(emo_sad, emo_angry, emo_grouchy, emo_worried, emo_anxious)), na.rm = TRUE),
pa = rowMeans(across(c(emo_happy, emo_cheerful, emo_excited, emo_energetic)), na.rm = TRUE),
event = parse_event01(event_occurred_clean),
sev_raw = parse_stress_num(event_stress_raw)
) %>%
filter(!is.na(els_id), !is.na(event), !is.na(na), !is.na(pa)) %>%
mutate(
stress = case_when(
event == 0L ~ 0,
event == 1L & !is.na(sev_raw) ~ sev_raw,
TRUE ~ NA_real_
)
) %>%
filter(!is.na(stress))
# -----------------------
# prep: full behavioral sample (n ids = 124) and mri subset (n ids = 80)
# -----------------------
df_full_person <- df_person  # assumes this file already reflects the reactivity sample (n = 124)
df_mri_person  <- df_person %>% filter(mri_flag)
df_full <- prep_long(df_full_person, df_prompt)
df_mri  <- prep_long(df_mri_person,  df_prompt)
# -----------------------
# fit models (main effects only)
# -----------------------
fit_full_na <- fit_main_effects(df_full, "na")
fit_full_pa <- fit_main_effects(df_full, "pa")
fit_mri_na <- fit_main_effects(df_mri, "na")
fit_mri_pa <- fit_main_effects(df_mri, "pa")
# -----------------------
# figure 1: full behavioral sample
# -----------------------
p1a <- plot_within(df_full, fit_full_na, "na", "full sample: within-person stress → negative affect")
p1b <- plot_between(df_full, "na",       "full sample: between-person mean stress → mean negative affect")
p1c <- plot_within(df_full, fit_full_pa, "pa", "full sample: within-person stress → positive affect")
p1d <- plot_between(df_full, "pa",       "full sample: between-person mean stress → mean positive affect")
fig_full <- (p1a | p1b) / (p1c | p1d)
ggsave("fig_stress_affect_full.png", fig_full, width = 12, height = 9, dpi = 300)
ggsave("fig_stress_affect_full.pdf", fig_full, width = 12, height = 9)
# -----------------------
# figure 2: mri subsample
# -----------------------
p2a <- plot_within(df_mri, fit_mri_na, "na", "mri subsample: within-person stress → negative affect")
p2b <- plot_between(df_mri, "na",      "mri subsample: between-person mean stress → mean negative affect")
p2c <- plot_within(df_mri, fit_mri_pa, "pa", "mri subsample: within-person stress → positive affect")
p2d <- plot_between(df_mri, "pa",      "mri subsample: between-person mean stress → mean positive affect")
fig_mri <- (p2a | p2b) / (p2c | p2d)
ggsave("fig_stress_affect_mri.png", fig_mri, width = 12, height = 9, dpi = 300)
ggsave("fig_stress_affect_mri.pdf", fig_mri, width = 12, height = 9)
# robust fits for main-effects-only figures (handles convergence)
suppressPackageStartupMessages({
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)
library(lme4)
library(lmerTest)
library(patchwork)
})
person_path <- "/Users/eu/Library/CloudStorage/OneDrive-Stanford/Research Projects/9 - EMA-Brain/ema_rsfmri_reactivity.csv"
prompt_path <- "/Users/eu/Documents/GitHub/els_ema_data/data/clean/ema_flags_master.csv"
parse_event01 <- function(x) {
x <- str_trim(as.character(x))
case_when(
x %in% c("1", "1.0", "true", "TRUE", "yes", "YES") ~ 1L,
x %in% c("0", "0.0", "false", "FALSE", "no", "NO") ~ 0L,
TRUE ~ NA_integer_
)
}
parse_stress_num <- function(x) {
x <- str_trim(toupper(as.character(x)))
x <- na_if(x, "CONDITION_SKIPPED")
x <- na_if(x, "")
suppressWarnings(readr::parse_number(x))
}
prep_long <- function(df_person, df_prompt) {
ids <- unique(df_person$els_id)
df_prompt %>%
filter(els_id %in% ids) %>%
group_by(els_id) %>%
mutate(
stress_mean = mean(stress01, na.rm = TRUE),
stress_dev  = stress01 - stress_mean
) %>%
ungroup()
}
fit_main_effects_safe <- function(dat, outcome) {
# try: correlated random slope -> uncorrelated random slope -> random intercept
f1 <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 + stress_dev | els_id)"))
f2 <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 + stress_dev || els_id)"))
f3 <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 | els_id)"))
tryCatch(
lmer(f1, data = dat, REML = FALSE,
control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))),
error = function(e1) tryCatch(
lmer(f2, data = dat, REML = FALSE,
control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))),
error = function(e2)
lmer(f3, data = dat, REML = FALSE)
)
)
}
pred_line <- function(fit, xseq, hold_mean) {
nd <- data.frame(stress_dev = xseq, stress_mean = hold_mean)
nd$yhat <- as.numeric(predict(fit, newdata = nd, re.form = NA))
nd
}
plot_within <- function(dat, fit, outcome_var, title_lab) {
hold_mean <- mean(dat$stress_mean, na.rm = TRUE)
xseq <- seq(min(dat$stress_dev, na.rm = TRUE), max(dat$stress_dev, na.rm = TRUE), length.out = 200)
nd <- pred_line(fit, xseq, hold_mean)
ggplot(dat, aes(x = stress_dev, y = .data[[outcome_var]])) +
stat_summary_bin(fun = mean, bins = 25, geom = "point") +
geom_line(data = nd, aes(x = stress_dev, y = yhat), linewidth = 1) +
labs(
title = title_lab,
x = "momentary stress (0–1; deviation from each adolescent’s mean)",
y = ifelse(outcome_var == "na", "negative affect", "positive affect")
) +
theme_classic(base_size = 14)
}
plot_between <- function(dat, outcome_var, title_lab) {
df_bp <- dat %>%
group_by(els_id) %>%
summarise(
stress_mean = mean(stress01, na.rm = TRUE),
affect_mean = mean(.data[[outcome_var]], na.rm = TRUE),
.groups = "drop"
)
ggplot(df_bp, aes(x = stress_mean, y = affect_mean)) +
geom_point() +
geom_smooth(method = "lm", se = TRUE) +
labs(
title = title_lab,
x = "average stress (0–1) across prompts",
y = ifelse(outcome_var == "na", "average negative affect", "average positive affect")
) +
theme_classic(base_size = 14)
}
# -----------------------
# load
# -----------------------
df_person <- read_csv(person_path, show_col_types = FALSE) %>%
mutate(els_id = as.character(els_id))
mri_flag <- if ("rest_final_at_tp" %in% names(df_person)) {
df_person$rest_final_at_tp == 1
} else if ("scan_available_at_timepoint" %in% names(df_person)) {
df_person$scan_available_at_timepoint == TRUE
} else {
rep(FALSE, nrow(df_person))
}
df_prompt <- read_csv(prompt_path, show_col_types = FALSE) %>%
mutate(
els_id = as.character(clean_id),
na = rowMeans(across(c(emo_sad, emo_angry, emo_grouchy, emo_worried, emo_anxious)), na.rm = TRUE),
pa = rowMeans(across(c(emo_happy, emo_cheerful, emo_excited, emo_energetic)), na.rm = TRUE),
event = parse_event01(event_occurred_clean),
sev_raw = parse_stress_num(event_stress_raw)
) %>%
filter(!is.na(els_id), !is.na(event), !is.na(na), !is.na(pa)) %>%
mutate(
stress = case_when(
event == 0L ~ 0,
event == 1L & !is.na(sev_raw) ~ sev_raw,
TRUE ~ NA_real_
),
stress01 = stress / 100
) %>%
filter(!is.na(stress01))
df_full <- prep_long(df_person, df_prompt)
df_mri  <- prep_long(df_person %>% filter(mri_flag), df_prompt)
# fits (safer)
fit_full_na <- fit_main_effects_safe(df_full, "na")
fit_full_pa <- fit_main_effects_safe(df_full, "pa")
fit_mri_na  <- fit_main_effects_safe(df_mri,  "na")
fit_mri_pa  <- fit_main_effects_safe(df_mri,  "pa")
# optional: print which random-effects structure ended up used
cat("full na formula:", format(formula(fit_full_na)), "\n")
cat("full pa formula:", format(formula(fit_full_pa)), "\n")
cat("mri  na formula:", format(formula(fit_mri_na)),  "\n")
cat("mri  pa formula:", format(formula(fit_mri_pa)),  "\n")
# figures
fig_full <- (plot_within(df_full, fit_full_na, "na", "full sample: within-person stress → negative affect") |
plot_between(df_full, "na", "full sample: between-person mean stress → mean negative affect")) /
(plot_within(df_full, fit_full_pa, "pa", "full sample: within-person stress → positive affect") |
plot_between(df_full, "pa", "full sample: between-person mean stress → mean positive affect"))
ggsave("fig_stress_affect_full.png", fig_full, width = 12, height = 9, dpi = 300)
ggsave("fig_stress_affect_full.pdf", fig_full, width = 12, height = 9)
fig_mri <- (plot_within(df_mri, fit_mri_na, "na", "mri subsample: within-person stress → negative affect") |
plot_between(df_mri, "na", "mri subsample: between-person mean stress → mean negative affect")) /
(plot_within(df_mri, fit_mri_pa, "pa", "mri subsample: within-person stress → positive affect") |
plot_between(df_mri, "pa", "mri subsample: between-person mean stress → mean positive affect"))
ggsave("fig_stress_affect_mri.png", fig_mri, width = 12, height = 9, dpi = 300)
ggsave("fig_stress_affect_mri.pdf", fig_mri, width = 12, height = 9)
fit_main_effects_safe <- function(dat, outcome) {
f_uncor <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 + stress_dev || els_id)"))
f_int   <- as.formula(paste0(outcome, " ~ stress_dev + stress_mean + (1 | els_id)"))
tryCatch(
lmer(
f_uncor, data = dat, REML = FALSE,
control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
),
error = function(e) lmer(f_int, data = dat, REML = FALSE)
)
}
lme4::isSingular(fit_full_na, tol = 1e-4)
summary(fit_full_na)$optinfo$conv$lme4$messages
